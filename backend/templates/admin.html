{% extends "base.html" %}

{% block title %}Admin Dashboard - Hotel AI{% endblock %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
{% endblock %}

{% block styles %}
.dashboard-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.notification-list {
    max-height: 300px;
    overflow-y: auto;
}

.notification {
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 5px;
}

.notification.new {
    background-color: #fffacd;
    border-left: 4px solid #ffd700;
    animation: fadeIn 1s;
}

.notification.maintenance {
    border-left: 4px solid #ff6347;
}

.notification.booking {
    border-left: 4px solid #4169e1;
}

.notification.room-service {
    border-left: 4px solid #4CAF50;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.status-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 5px;
}

.status-indicator.online {
    background-color: #4CAF50;
}

.status-indicator.offline {
    background-color: #f44336;
}

.emergency {
    background-color: #ffebee;
    color: #d32f2f;
    font-weight: bold;
}

.high {
    background-color: #fff8e1;
    color: #ff8f00;
    font-weight: bold;
}

.popup-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px;
    background-color: #4CAF50;
    color: white;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    display: none;
    z-index: 1000;
}
{% endblock %}

{% block content %}
<h1>Admin Dashboard</h1>

<div class="card">
    <div class="connection-status">
        <span class="status-indicator offline" id="connection-indicator"></span>
        <span id="connection-status">Disconnected</span>
    </div>
</div>

<div class="popup-notification" id="new-notification-popup">
    New notification received!
</div>

<div class="dashboard-grid">
    <div class="card">
        <h2>Recent Notifications</h2>
        <div class="notification-list" id="notification-list">
            <p id="no-notifications-message">No notifications yet.</p>
        </div>
    </div>
    
    <div class="card">
        <h2>Active Guests</h2>
        <div class="tabs">
            <button class="tab-button active" data-tab="today">Today</button>
            <button class="tab-button" data-tab="tomorrow">Tomorrow</button>
            <button class="tab-button" data-tab="yesterday">Yesterday</button>
        </div>
        <div class="tab-content active" id="today-tab">
            <table>
                <thead>
                    <tr>
                        <th>Room</th>
                        <th>Status</th>
                        <th>Last Activity</th>
                    </tr>
                </thead>
                <tbody id="active-guests-today">
                </tbody>
            </table>
        </div>
        <div class="tab-content" id="tomorrow-tab" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>Room</th>
                        <th>Status</th>
                        <th>Check-in Time</th>
                    </tr>
                </thead>
                <tbody id="active-guests-tomorrow">
                </tbody>
            </table>
        </div>
        <div class="tab-content" id="yesterday-tab" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>Room</th>
                        <th>Status</th>
                        <th>Check-out Time</th>
                    </tr>
                </thead>
                <tbody id="active-guests-yesterday">
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const connectionIndicator = document.getElementById('connection-indicator');
        const connectionStatus = document.getElementById('connection-status');
        const notificationList = document.getElementById('notification-list');
        const noNotificationsMessage = document.getElementById('no-notifications-message');
        const popupNotification = document.getElementById('new-notification-popup');
        
        let socket = null;
        let notifications = [];
        
        // Show popup notification
        function showPopupNotification() {
            popupNotification.style.display = 'block';
            setTimeout(() => {
                popupNotification.style.display = 'none';
            }, 3000);
        }
        
        // Connect to Socket.IO
        function connectSocket() {
            // Create new Socket.IO connection with admin namespace
            socket = io('/admin');
            
            socket.on('connect', function() {
                console.log('Admin Socket.IO connection established');
                connectionIndicator.classList.remove('offline');
                connectionIndicator.classList.add('online');
                connectionStatus.textContent = 'Connected';
            });
            
            socket.on('notification', function(data) {
                console.log('Notification from server:', data);
                handleNotification(data);
            });
            
            socket.on('connection_status', function(data) {
                if (data.status === 'connected') {
                    connectionIndicator.classList.remove('offline');
                    connectionIndicator.classList.add('online');
                    connectionStatus.textContent = 'Connected';
                } else {
                    connectionIndicator.classList.remove('online');
                    connectionIndicator.classList.add('offline');
                    connectionStatus.textContent = 'Disconnected';
                }
            });
            
            socket.on('disconnect', function() {
                console.log('Socket.IO connection closed');
                connectionIndicator.classList.remove('online');
                connectionIndicator.classList.add('offline');
                connectionStatus.textContent = 'Disconnected';
            });
            
            socket.on('connect_error', function(error) {
                console.error('Socket.IO connection error:', error);
                connectionIndicator.classList.remove('online');
                connectionIndicator.classList.add('offline');
                connectionStatus.textContent = 'Connection Error';
            });
        }
        
        // Handle notification
        function handleNotification(data) {
            // Show popup notification
            showPopupNotification();
            
            // Hide the "no notifications" message if it's visible
            if (noNotificationsMessage.style.display !== 'none') {
                noNotificationsMessage.style.display = 'none';
            }
            
            const notificationDiv = document.createElement('div');
            notificationDiv.className = `notification new ${data.event}`;
            
            const time = new Date().toLocaleTimeString();
            let notificationContent = '';
            
            switch (data.event) {
                case 'room_service_request':
                    notificationContent = `
                        <h4>Room Service Request - Room ${data.payload.roomNumber}</h4>
                        <p><strong>Request:</strong> ${data.payload.request}</p>
                        <p><strong>Time:</strong> ${time}</p>
                    `;
                    break;
                    
                default:
                    notificationContent = `
                        <h4>${data.event}</h4>
                        <p>${JSON.stringify(data.payload)}</p>
                        <p><strong>Time:</strong> ${time}</p>
                    `;
            }
            
            notificationDiv.innerHTML = notificationContent;
            
            // Add to the top of the list
            notificationList.insertBefore(notificationDiv, notificationList.firstChild);
            
            // Remove 'new' class after animation
            setTimeout(() => {
                notificationDiv.classList.remove('new');
            }, 2000);
            
            // Update active guests if needed
            if (data.event === 'guest_activity') {
                updateActiveGuests(data.payload);
            }
        }
        
        // Update active guests
        function updateActiveGuests(guestData) {
            const todayTableBody = document.getElementById('active-guests-today');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${guestData.roomNumber}</td>
                <td>${guestData.status}</td>
                <td>${new Date().toLocaleTimeString()}</td>
            `;
            
            // Add to the top of the table
            todayTableBody.insertBefore(row, todayTableBody.firstChild);
        }
        
        // Tab functionality
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.style.display = 'none');
                
                this.classList.add('active');
                document.getElementById(`${tabName}-tab`).style.display = 'block';
            });
        });
        
        // Initial connection
        connectSocket();
    });
</script>
{% endblock %}