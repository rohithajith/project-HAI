{% extends "base.html" %}

{% block title %}Room Service Dashboard - Hotel AI{% endblock %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
{% endblock %}

{% block styles %}
.request-list {
    max-height: 500px;
    overflow-y: auto;
}

.request-card {
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    background-color: white;
}

.request-card.new {
    background-color: #fffacd;
    border-left: 4px solid #ffd700;
    animation: fadeIn 1s;
}

.request-card.food {
    border-left: 4px solid #4CAF50;
}

.request-card.drink {
    border-left: 4px solid #2196F3;
}

.request-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.request-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 10px;
}

.request-actions button {
    margin-left: 10px;
}

.status-badge {
    display: inline-block;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: bold;
}

.status-badge.pending {
    background-color: #FFC107;
    color: #333;
}

.status-badge.in-progress {
    background-color: #2196F3;
    color: white;
}

.status-badge.delivered {
    background-color: #4CAF50;
    color: white;
}

.connection-status {
    margin-bottom: 20px;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px;
    background-color: #4CAF50;
    color: white;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    display: none;
    z-index: 1000;
}
{% endblock %}

{% block content %}
<h1>Room Service Dashboard</h1>

<div class="card">
    <div class="connection-status">
        <span class="status-indicator offline" id="connection-indicator"></span>
        <span id="connection-status">Disconnected</span>
    </div>
</div>

<div class="notification" id="new-request-notification">
    New room service request received!
</div>

<div class="card">
    <h2>Active Requests</h2>
    <div class="request-list" id="request-list">
        <p id="no-requests-message">No active requests at the moment.</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const connectionIndicator = document.getElementById('connection-indicator');
        const connectionStatus = document.getElementById('connection-status');
        const requestList = document.getElementById('request-list');
        const noRequestsMessage = document.getElementById('no-requests-message');
        const notification = document.getElementById('new-request-notification');
        
        let socket = null;
        let requests = [];
        
        // Show notification
        function showNotification() {
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // Connect to Socket.IO
        function connectSocket() {
            // Create new Socket.IO connection with room-service namespace
            socket = io('/room-service');
            
            socket.on('connect', function() {
                console.log('Room Service Socket.IO connection established');
                connectionIndicator.classList.remove('offline');
                connectionIndicator.classList.add('online');
                connectionStatus.textContent = 'Connected';
            });
            
            socket.on('notification', function(data) {
                console.log('Notification from server:', data);
                handleNotification(data);
            });
            
            socket.on('connection_status', function(data) {
                if (data.status === 'connected') {
                    connectionIndicator.classList.remove('offline');
                    connectionIndicator.classList.add('online');
                    connectionStatus.textContent = 'Connected';
                } else {
                    connectionIndicator.classList.remove('online');
                    connectionIndicator.classList.add('offline');
                    connectionStatus.textContent = 'Disconnected';
                }
            });
            
            socket.on('disconnect', function() {
                console.log('Socket.IO connection closed');
                connectionIndicator.classList.remove('online');
                connectionIndicator.classList.add('offline');
                connectionStatus.textContent = 'Disconnected';
            });
            
            socket.on('connect_error', function(error) {
                console.error('Socket.IO connection error:', error);
                connectionIndicator.classList.remove('online');
                connectionIndicator.classList.add('offline');
                connectionStatus.textContent = 'Connection Error';
            });
        }
        
        // Handle notification
        function handleNotification(data) {
            if (data.event === 'room_service_request') {
                // Show notification
                showNotification();
                
                // Hide the "no requests" message if it's visible
                if (noRequestsMessage.style.display !== 'none') {
                    noRequestsMessage.style.display = 'none';
                }
                
                const payload = data.payload;
                const roomNumber = payload.roomNumber || 'Unknown';
                const requestId = Date.now(); // Generate a unique ID
                
                // Create request object
                const request = {
                    id: requestId,
                    roomNumber: roomNumber,
                    request: payload.request,
                    status: 'pending',
                    timestamp: payload.timestamp
                };
                
                // Add to requests array
                requests.push(request);
                
                // Create and add request card
                const requestCard = createRequestCard(request);
                requestList.insertBefore(requestCard, requestList.firstChild);
                
                // Remove 'new' class after animation
                setTimeout(() => {
                    requestCard.classList.remove('new');
                }, 2000);
            }
        }
        
        // Create request card
        function createRequestCard(request) {
            const card = document.createElement('div');
            card.className = 'request-card new';
            card.id = `request-${request.id}`;
            
            const statusText = request.status.charAt(0).toUpperCase() + request.status.slice(1);
            const time = new Date(request.timestamp * 1000).toLocaleTimeString();
            
            card.innerHTML = `
                <div class="request-header">
                    <h3>Room ${request.roomNumber}</h3>
                    <span class="status-badge ${request.status}">${statusText}</span>
                </div>
                <p><strong>Request:</strong> ${request.request}</p>
                <p><strong>Time:</strong> ${time}</p>
                <div class="request-actions">
                    ${request.status === 'pending' ? `
                        <button class="start-button" data-id="${request.id}">Start Preparing</button>
                        <button class="deliver-button" data-id="${request.id}">Mark Delivered</button>
                    ` : request.status === 'in-progress' ? `
                        <button class="deliver-button" data-id="${request.id}">Mark Delivered</button>
                    ` : `
                        <button class="remove-button" data-id="${request.id}">Remove</button>
                    `}
                </div>
            `;
            
            // Add event listeners
            setTimeout(() => {
                const startButtons = card.querySelectorAll('.start-button');
                const deliverButtons = card.querySelectorAll('.deliver-button');
                const removeButtons = card.querySelectorAll('.remove-button');
                
                startButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        updateRequestStatus(this.getAttribute('data-id'), 'in-progress');
                    });
                });
                
                deliverButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        updateRequestStatus(this.getAttribute('data-id'), 'delivered');
                    });
                });
                
                removeButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        removeRequest(this.getAttribute('data-id'));
                    });
                });
            }, 0);
            
            return card;
        }
        
        // Update request status
        function updateRequestStatus(requestId, newStatus) {
            const requestIndex = requests.findIndex(req => req.id.toString() === requestId);
            if (requestIndex !== -1) {
                requests[requestIndex].status = newStatus;
                
                const requestCard = document.getElementById(`request-${requestId}`);
                if (requestCard) {
                    const statusBadge = requestCard.querySelector('.status-badge');
                    statusBadge.className = `status-badge ${newStatus}`;
                    statusBadge.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
                    
                    const actionsDiv = requestCard.querySelector('.request-actions');
                    if (newStatus === 'in-progress') {
                        actionsDiv.innerHTML = `
                            <button class="deliver-button" data-id="${requestId}">Mark Delivered</button>
                        `;
                    } else if (newStatus === 'delivered') {
                        actionsDiv.innerHTML = `
                            <button class="remove-button" data-id="${requestId}">Remove</button>
                        `;
                    }
                    
                    // Add event listeners to new buttons
                    const deliverButtons = actionsDiv.querySelectorAll('.deliver-button');
                    const removeButtons = actionsDiv.querySelectorAll('.remove-button');
                    
                    deliverButtons.forEach(button => {
                        button.addEventListener('click', function() {
                            updateRequestStatus(this.getAttribute('data-id'), 'delivered');
                        });
                    });
                    
                    removeButtons.forEach(button => {
                        button.addEventListener('click', function() {
                            removeRequest(this.getAttribute('data-id'));
                        });
                    });
                }
            }
        }
        
        // Remove request
        function removeRequest(requestId) {
            const requestIndex = requests.findIndex(req => req.id.toString() === requestId);
            if (requestIndex !== -1) {
                requests.splice(requestIndex, 1);
                
                const requestCard = document.getElementById(`request-${requestId}`);
                if (requestCard) {
                    requestCard.remove();
                }
                
                if (requests.length === 0) {
                    noRequestsMessage.style.display = 'block';
                }
            }
        }
        
        // Initial connection
        connectSocket();
    });
</script>
{% endblock %}